<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="description" content="PWA за изчисляване на ресто в BGN и EUR — курс 1 EUR = 1.95583 BGN" />
  <meta name="theme-color" content="#07203a" />
  <!-- iOS / Apple tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>Ресто — BGN / EUR</title>

  <!-- Fonts: артистичен за заглавия и стегнат за интерфейс -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#041228;
      --panel:#07203a;
      --glass-bg: rgba(18,32,50,0.48);
      --accent:#2b6df6;
      --muted:#9aa6b2;
      --card-radius:18px;
      --rate:1.95583;
    }
    html,body,#app{
      height:100%;
      margin:0;
      font-family: "Roboto Condensed", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background: linear-gradient(180deg,var(--bg) 0%, #031523 100%);
      color:#e6f0ff;
    }

    /* App-like window */
    .app-window{
      max-width:780px;
      margin:22px auto;
      border-radius:20px;
      padding:16px;
      position:relative;
      overflow:hidden;
      box-shadow: 0 24px 60px rgba(0,10,30,0.7), inset 0 1px 0 rgba(255,255,255,0.02);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      border: 1px solid rgba(255,255,255,0.04);
      z-index:1;
    }

    /* Header logo tile */
    .logo-tile{
      width:56px;height:56px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(180deg,var(--accent),#1857d6);
      box-shadow: 0 8px 26px rgba(27,90,200,0.26);
      flex-shrink:0;
    }
    .app-title{
      font-family: "Quicksand", "Segoe UI", Roboto, Arial;
      font-weight:700;
      letter-spacing:0.2px;
      color:#fff;
    }
    .subtitle{ color:var(--muted); font-weight:600; font-size:0.9rem; }

    /* Input card style */
    .input-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:12px;
      border:1px solid rgba(255,255,255,0.03);
    }
    input[type="number"], select{
      background: rgba(255,255,255,0.015);
      border: 1px solid rgba(255,255,255,0.03);
      color: #eaf4ff;
      padding:12px 14px;
      border-radius:10px;
      outline:none;
      width:100%;
      font-size:1rem;
    }
    input[type="number"]::placeholder{ color: rgba(231,240,251,0.45); }

    /* Segmented control */
    .segmented button{
      padding:8px 12px;
      border-radius:10px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.03);
      color:var(--muted);
      font-weight:700;
      font-size:0.95rem;
    }
    .segmented button.active{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:#fff;
      border-color: rgba(255,255,255,0.06);
      box-shadow: inset 0 -2px 10px rgba(0,0,0,0.35);
    }

    /* Result card */
    .result-card{
      transition: transform .32s cubic-bezier(.18,.9,.32,1), opacity .28s ease;
      transform-origin: top center;
      opacity:0;
      transform: translateY(8px) scale(.995);
    }
    .result-card.visible{
      opacity:1;
      transform: translateY(0) scale(1);
    }

    /* Error box */
    .error-box{
      background: linear-gradient(180deg, rgba(220,38,38,0.12), rgba(220,38,38,0.06));
      border:1px solid rgba(220,38,38,0.18);
      color:#ffdede;
      padding:10px 12px;
      border-radius:10px;
      font-weight:700;
    }

    /* Pattern grid (dynamic background) */
    .pattern-grid{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      grid-auto-rows: minmax(64px, 1fr);
      gap:8px;
      padding:18px;
      pointer-events:none;
      z-index:0;
      opacity:0.08; /* строго зададено */
      color:#2f3940;
      mix-blend-mode:normal;
    }
    .pattern-cell{
      display:flex;align-items:center;justify-content:center;
      width:100%;height:100%;
      filter: saturate(.7);
    }

    /* Floating animation */
    @keyframes floatish{
      0%{ transform: translate3d(-4px, -6px, 0) rotate(-2deg) scale(0.98); }
      50%{ transform: translate3d(6px, 6px, 0) rotate(2deg) scale(1.02); }
      100%{ transform: translate3d(-4px, -6px, 0) rotate(-2deg) scale(0.98); }
    }
    .float{
      animation: floatish 6s ease-in-out infinite;
      transform-origin:center;
    }

    /* Footer */
    footer{ font-size:0.88rem; color:var(--muted); text-align:center; padding-top:10px; padding-bottom:8px;}

    /* Mobile / one-handed optimizations */
    @media (max-width:640px){
      .app-window{ margin:12px 12px; border-radius:16px; padding:12px; }
      .pattern-grid{ grid-template-columns: repeat(6, 1fr); gap:6px; padding:12px; }
      input[type="number"], select{ padding:14px; font-size:1.05rem; }
      .logo-tile{ width:52px; height:52px; }
      .app-title{ font-size:1.05rem; }
    }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen flex items-center justify-center p-4">
    <div class="app-window w-full relative max-w-lg" role="application" aria-label="Ресто – приложение">
      <!-- Dynamic pattern background -->
      <div id="pattern" class="pattern-grid" aria-hidden="true"></div>

      <!-- Content (z-index above pattern) -->
      <div class="relative z-10">
        <!-- Header -->
        <div class="flex items-center gap-4">
          <div class="logo-tile" aria-hidden="true">
            <!-- blue tile with euro symbol (logo) -->
            <svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <rect x="0" y="0" width="24" height="24" rx="6" fill="transparent"></rect>
              <path d="M15.5 7C13.5 6 11.5 6 9.5 6" stroke="#fff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M15.5 17C13.5 18 11.5 18 9.5 18" stroke="#fff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M14 4.5C12 3.9 10.5 3.9 8.5 4.5V19.5C10.5 20.1 12 20.1 14 19.5" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9 9.5H13" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9 14.5H13" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>

          <div class="flex-1">
            <div class="app-title text-lg">Ресто — Бързо и точно</div>
            <div class="subtitle">Курс: 1 EUR = 1.95583 BGN</div>
          </div>

          <div class="text-right">
            <button id="installBtn" class="px-3 py-2 rounded-md" style="border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);font-weight:700">Инсталирай</button>
          </div>
        </div>

        <!-- Main form -->
        <div class="mt-4 space-y-4">
          <!-- Сума за плащане -->
          <div class="input-card">
            <label class="block text-sm mb-2" style="color:var(--muted);font-weight:800">Сума за плащане</label>
            <div class="flex gap-3">
              <input id="amount" type="number" min="0" step="0.01" placeholder="0.00" inputmode="decimal" aria-label="Сума за плащане" />
              <select id="amount-currency" aria-label="Валута на сумата" class="w-36" title="Валута">
                <option value="BGN">BGN</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
          </div>

          <!-- Платено в лв и в € -->
          <div class="grid grid-cols-2 gap-3">
            <div class="input-card">
              <label class="block text-sm mb-2" style="color:var(--muted);font-weight:800">Платено в лв</label>
              <input id="paid-bgn" type="number" min="0" step="0.01" placeholder="0.00" inputmode="decimal" aria-label="Платено в лева" />
            </div>
            <div class="input-card">
              <label class="block text-sm mb-2" style="color:var(--muted);font-weight:800">Платено в €</label>
              <input id="paid-eur" type="number" min="0" step="0.01" placeholder="0.00" inputmode="decimal" aria-label="Платено в евро" />
            </div>
          </div>

          <!-- Error box placeholder -->
          <div id="error" class="hidden"></div>

          <!-- Резултат и сегментиран контрол -->
          <div class="input-card">
            <div class="flex items-center justify-between mb-2">
              <div style="color:var(--muted);font-weight:800">Резултат</div>
              <div class="segmented inline-flex bg-transparent p-1 rounded-md" role="tablist" aria-label="Показвай рестото в">
                <button id="show-bgn" class="active" role="tab" aria-selected="true">BGN</button>
                <button id="show-eur" role="tab" aria-selected="false">EUR</button>
              </div>
            </div>

            <div id="resultCard" class="result-card">
              <div class="text-3xl font-bold" id="change-primary" style="color:#fff">0.00 лв</div>
              <div class="text-sm" id="change-secondary" style="color:var(--muted)">≈ 0.00 €</div>
            </div>

            <!-- Download button (показва се когато има резултат) -->
            <div class="flex justify-end mt-3">
              <button id="downloadBtn" class="px-3 py-2 rounded-md" style="border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);font-weight:700;display:none" aria-label="Изтегли бележка">Свали бележка</button>
            </div>

          </div>
        </div>

        <!-- Footer -->
        <footer class="mt-4">
          <div>Курс: 1 EUR = 1.95583 BGN</div>
          <div style="font-weight:800;margin-top:6px">ИВАН КАРАМФИЛОВ ©</div>
        </footer>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Настройки и елементи ---------- */
    const RATE = 1.95583; // фиксиран курс
    const amountEl = document.getElementById('amount');
    const amountCurEl = document.getElementById('amount-currency');
    const paidBgnEl = document.getElementById('paid-bgn');
    const paidEurEl = document.getElementById('paid-eur');
    const errorEl = document.getElementById('error');
    const resultCard = document.getElementById('resultCard');
    const changePrimary = document.getElementById('change-primary');
    const changeSecondary = document.getElementById('change-secondary');
    const showBgnBtn = document.getElementById('show-bgn');
    const showEurBtn = document.getElementById('show-eur');
    const installBtn = document.getElementById('installBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    let displayCurrency = 'BGN';
    let lastComputed = null; // ще съдържа последните изчислени стойности

    // Форматиране
    const fmtBGN = (v) => {
      return Number(v || 0).toLocaleString('bg-BG', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' лв';
    };
    const fmtEUR = (v) => {
      return Number(v || 0).toLocaleString('bg-BG', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';
    };

    function parseNum(el){
      const v = parseFloat(el.value);
      return isNaN(v) ? 0 : v;
    }

    /* ---------- Логика за изчисления (реално време) ---------- */
    function compute(){
      const amount = parseNum(amountEl);
      const amountCur = amountCurEl.value; // 'BGN' или 'EUR'

      // Превърни сумата за плащане в BGN за базова проверка
      const requiredBGN = amountCur === 'BGN' ? amount : amount * RATE;

      // Въведени плащания
      const paidBGN = parseNum(paidBgnEl);
      const paidEUR = parseNum(paidEurEl);
      const totalPaidBGN = paidBGN + (paidEUR * RATE);

      const diffBGN = totalPaidBGN - requiredBGN;

      if (requiredBGN <= 0) {
        // Няма въведена сума за плащане — скрий резултата и грешките
        hideError();
        hideResult();
        lastComputed = null;
        return;
      }

      if (diffBGN < -0.0005) {
        // недостатъчна сума
        showError(requiredBGN - totalPaidBGN);
        hideResult();
        lastComputed = {
          amount, amountCur, paidBGN, paidEUR, requiredBGN, totalPaidBGN, changeBGN: 0, timestamp: new Date().toISOString()
        };
      } else {
        hideError();
        const changeBGN = Math.max(0, diffBGN);
        lastComputed = { amount, amountCur, paidBGN, paidEUR, requiredBGN, totalPaidBGN, changeBGN, timestamp: new Date().toISOString() };
        showResult(changeBGN);
      }
    }

    function showError(missingBGN){
      errorEl.classList.remove('hidden');
      errorEl.innerHTML = '';
      const box = document.createElement('div');
      box.className = 'error-box';
      box.textContent = 'Недостатъчна сума — липсват ' + fmtBGN(missingBGN);
      errorEl.appendChild(box);
      resultCard.classList.remove('visible');
      // скриваме бутона за сваляне при грешка
      downloadBtn.style.display = 'none';
    }

    function hideError(){
      errorEl.classList.add('hidden');
      errorEl.innerHTML = '';
    }

    function showResult(changeBGN){
      if (displayCurrency === 'BGN'){
        changePrimary.textContent = fmtBGN(changeBGN);
        changeSecondary.textContent = '≈ ' + fmtEUR(changeBGN / RATE);
      } else {
        const changeEUR = changeBGN / RATE;
        changePrimary.textContent = fmtEUR(changeEUR);
        changeSecondary.textContent = '≈ ' + fmtBGN(changeBGN);
      }
      resultCard.classList.add('visible');
      // Покажи бутона за сваляне
      downloadBtn.style.display = 'inline-block';
    }

    function hideResult(){
      resultCard.classList.remove('visible');
      // Скриваме бутона за сваляне
      downloadBtn.style.display = 'none';
    }

    // Слушатели за полетата (реално време)
    [amountEl, amountCurEl, paidBgnEl, paidEurEl].forEach(el => {
      el.addEventListener('input', () => compute());
    });

    // Сегментиран контрол за резултата
    showBgnBtn.addEventListener('click', () => {
      displayCurrency = 'BGN';
      showBgnBtn.classList.add('active');
      showEurBtn.classList.remove('active');
      compute();
    });
    showEurBtn.addEventListener('click', () => {
      displayCurrency = 'EUR';
      showEurBtn.classList.add('active');
      showBgnBtn.classList.remove('active');
      compute();
    });

    /* ---------- Download / Свали бележка ---------- */
    function downloadReceipt() {
      if (!lastComputed) return;

      const dt = new Date(lastComputed.timestamp || Date.now());
      const when = dt.toLocaleString('bg-BG');

      const amountLine = lastComputed.amountCur === 'BGN'
        ? `${fmtBGN(lastComputed.amount)}`
        : `${fmtEUR(lastComputed.amount)}`;

      const paidBGNLine = fmtBGN(lastComputed.paidBGN);
      const paidEURLine = fmtEUR(lastComputed.paidEUR);
      const totalPaidBGNLine = fmtBGN(lastComputed.totalPaidBGN);
      const requiredBGNLine = fmtBGN(lastComputed.requiredBGN);
      const changeBGNLine = fmtBGN(lastComputed.changeBGN);
      const changeEURLine = fmtEUR(lastComputed.changeBGN / RATE);

      const lines = [
        'Ресто — бележка',
        '======================',
        `Дата: ${when}`,
        '',
        `Сума за плащане: ${amountLine}`,
        `Платено: ${paidBGNLine} (лв) + ${paidEURLine} (€)`,
        `Общо платено (BGN): ${totalPaidBGNLine}`,
        `Изисквана (BGN): ${requiredBGNLine}`,
        '',
        `Ресто: ${changeBGNLine} ≈ ${changeEURLine}`,
        '',
        `Курс: 1 EUR = ${RATE} BGN`,
        '----------------------',
        'Генерирано от Ресто — BGN / EUR'
      ];

      const content = lines.join('\n');
      const filename = `resto-${dt.getFullYear()}${String(dt.getMonth()+1).padStart(2,'0')}${String(dt.getDate()).padStart(2,'0')}-${String(dt.getHours()).padStart(2,'0')}${String(dt.getMinutes()).padStart(2,'0')}${String(dt.getSeconds()).padStart(2,'0')}.txt`;

      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    downloadBtn.addEventListener('click', downloadReceipt);

    /* ---------- Динамично генериране на manifest и икона (SVG) ---------- */
    function createInstallIconDataURL(size = 192, bg = '#6b7280', fg = '#ffffff') {
      const svg = `
        <svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 120 120'>
          <rect width='120' height='120' rx='20' fill='${bg}'/>
          <g transform='translate(18,18) scale(0.8)' fill='none' stroke='${fg}' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'>
            <path d='M48 10c18 0 28 7 28 20s-10 20-28 20' />
            <path d='M52 18h-14' />
            <path d='M52 36h-14' />
          </g>
        </svg>`;
      return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }

    // Създаваме manifest динамично и го закачаме
    function installManifest() {
      const iconData = createInstallIconDataURL(192, '#6b7280', '#ffffff');
      const manifest = {
        name: "Ресто — BGN / EUR",
        short_name: "Ресто",
        description: "Изчисляване на ресто в BGN и EUR при курс 1.95583",
        icons: [
          { src: iconData, sizes: "192x192", type: "image/svg+xml" },
          { src: iconData, sizes: "512x512", type: "image/svg+xml" }
        ],
        start_url: ".",
        display: "standalone",
        background_color: "#041228",
        theme_color: "#07203a",
        scope: "/"
      };
      const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
      const manifestURL = URL.createObjectURL(manifestBlob);
      // Прикачи към DOM
      let link = document.querySelector('link[rel="manifest"]');
      if (!link) {
        link = document.createElement('link');
        link.rel = 'manifest';
        document.head.appendChild(link);
      }
      link.href = manifestURL;

      // Apple touch icon
      const appleLinkId = 'apple-touch';
      let apple = document.getElementById(appleLinkId);
      if (!apple) {
        apple = document.createElement('link');
        apple.id = appleLinkId;
        apple.rel = 'apple-touch-icon';
        document.head.appendChild(apple);
      }
      apple.href = iconData;
    }

    installManifest();

    /* ---------- Управление на инсталацията (beforeinstallprompt) ---------- */
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        deferredPrompt = null;
      } else {
        // Ако събитие няма (на iOS) покажи подсказка
        alert('За да инсталирате: добавете към началния екран (Share → Add to Home Screen).');
      }
    });

    /* ---------- Динамичен шахматен фон (строго редуващи се символи) ---------- */
    const patternEl = document.getElementById('pattern');

    // Символи (SVG) — строго тематични: монета, символ €, банкнота, receipt, портфейл, калкулатор
    const symbols = [
      // монета
      `<svg viewBox="0 0 24 24" width="42" height="42" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="7" stroke="currentColor" stroke-width="1.2"/><path d="M12 9v6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>`,
      // символ евро
      `<svg viewBox="0 0 24 24" width="42" height="42" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 7C13.5 6 11.5 6 9.5 6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><path d="M15.5 17C13.5 18 11.5 18 9.5 18" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>`,
      // банкнота
      `<svg viewBox="0 0 24 24" width="42" height="42" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2.5" y="6.5" width="19" height="11" rx="2" stroke="currentColor" stroke-width="1.2"/><circle cx="12" cy="12" r="2" stroke="currentColor" stroke-width="1.2"/></svg>`,
      // касова бележка / receipt
      `<svg viewBox="0 0 24 24" width="42" height="42" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 2h9l3 3v15l-3-2-3 2-3-2-3 2V2z" stroke="currentColor" stroke-width="1.1" stroke-linecap="round"/></svg>`,
      // портфейл
      `<svg viewBox="0 0 24 24" width="42" height="42" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.2"/><path d="M16 10h2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>`,
      // калкулатор
      `<svg viewBox="0 0 24 24" width="42" height="42" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="2" width="14" height="20" rx="2" stroke="currentColor" stroke-width="1.1"/><rect x="8" y="6" width="8" height="3" rx="0.5" stroke="currentColor" stroke-width="1.1"/></svg>`
    ];

    // Генерираме мрежа от клетки и ги попълваме строго в цикличен ред
    function populatePattern() {
      patternEl.innerHTML = '';
      const cols = window.innerWidth < 640 ? 6 : 8;
      const rows = 6;
      const total = cols * rows;
      for (let i = 0; i < total; i++) {
        const cell = document.createElement('div');
        cell.className = 'pattern-cell';
        // Строго редуване
        const symbol = symbols[i % symbols.length];
        cell.innerHTML = symbol;
        // анимиране: добавяме клас float с вариации
        const node = cell.firstElementChild;
        const wrapper = document.createElement('div');
        wrapper.style.width = '100%';
        wrapper.style.display = 'flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.justifyContent = 'center';
        wrapper.className = 'float';
        // Вариации
        const dur = 5 + (i % 5); // 5..9s
        const delay = (i % 6) * 0.2; // stagger
        wrapper.style.animationDuration = `${dur}s`;
        wrapper.style.animationDelay = `${delay}s`;
        wrapper.style.transformOrigin = 'center';
        wrapper.innerHTML = symbol;
        // Намаляваме цвета – използваме currentColor и patternEl color
        cell.appendChild(wrapper);
        patternEl.appendChild(cell);
      }
    }
    populatePattern();
    window.addEventListener('resize', () => populatePattern());

    /* ---------- Service Worker (offline, single-file) ---------- */
    // Създаваме service worker динамично като blob и го регистрираме
    const swCode = `
      const CACHE_NAME = 'resto-pwa-v1';
      const ASSETS = ['.'];
      self.addEventListener('install', (e) => {
        self.skipWaiting();
        e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS)));
      });
      self.addEventListener('activate', (e) => {
        e.waitUntil(clients.claim());
      });
      self.addEventListener('fetch', (e) => {
        e.respondWith(
          caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match('.')))
        );
      });
    `;
    if ('serviceWorker' in navigator) {
      try {
        const swBlob = new Blob([swCode], { type: 'text/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl, { scope: './' }).catch(() => {
          // Някои браузъри може да не позволят blob SW; в такъв случай опитваме да регистрираме без blob (fallback)
          console.warn('Регистрация на service worker неуспешна от blob.');
        });
      } catch (err) {
        console.warn('Service worker registration failed:', err);
      }
    }

    /* ---------- Accessibility / shortcuts ---------- */
    // Направяме бутоните по-достъпни за клавиатура
    [showBgnBtn, showEurBtn, installBtn, downloadBtn].forEach(b => {
      b.setAttribute('tabindex', '0');
    });

   
    // Ако браузърът не поддържа beforeinstallprompt, показваме съвет за iOS
    window.addEventListener('load', () => {
      // Ако има PWA възможност но без beforeinstallprompt, все още можем да предложим иконата (apple-touch)
      // Понеже manifest вече е добавен, браузърите могат да предложат автоматично.
    });

    // Полезна помощ за тест: предварително попълване (може да се премахне)
    // amountEl.value = '12.34'; paidBgnEl.value = '20'; compute();
  </script>
</body>
</html>